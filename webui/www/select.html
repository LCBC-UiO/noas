<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<link rel="shortcut icon" href="./img/favicon.ico">
<link rel="stylesheet" href="./css/layout.css" type="text/css"/>
<link rel="stylesheet" href="./css/bootstrap.min.css" type="text/css"/>
<link rel="stylesheet" href="./css/bootstrap.css" type="text/css"/>
<link rel="stylesheet" href="./css/optbox.css" type="text/css"/>
<script type="text/javascript" src="./js/solid.min.js" ></script>
<script type="text/javascript" src="./js/fontawesome.min.js"></script>
<script type="text/javascript" src="./js/jquery.min.js"></script>
<script type="text/javascript" src="./js//popper.min.js"></script>
<script type="text/javascript" src="./js/bootstrap.min.js"></script>
<script type="text/javascript" src="./js/lcalerts.js"></script>
<script type="text/javascript" src="./js/lchelper.js"></script>

<title>
NOAS - Query selector
</title>
</head>
<body>
  
  <nav class="navbar navbar-expand navbar-dark">
    <a class="navbar-brand font-weight-bold" href="./index.html">
      <script language="JavaScript">
        var request = new XMLHttpRequest()
        request.open('GET', './static_info.json', false); 
        request.send(null);
        if (request.status === 200) {
          document.write(JSON.parse(request.responseText).instance_name);
        }
      </script>
    </a>
    <span class="navbar-text" id="version-label">&nbsp;</span>
    <span class="hidden" id="version-id">.</span>
    <a class="ml-auto" href="./index.html">
      <span class="navbar-text">Project:</span>
      <span class="navbar-text ml-1" id="spPrj"></span>
    </a>
  </nav>

  <div class="container">
    <div id="alerts"></div>
  </div>
  <div class="d-flex">
    <div class="h4 mt-1">
      Database Query
      <a href="#" data-toggle="popover" data-trigger="focus" title="Help"
        data-content="Select the data you are interested in and press 'Submit' (bottom).">
        <i class="bluehover fas fa-question-circle" aria-hidden="true"></i>
      </a>
    </div>
    <div id="btnClear" class="button button-minwidth ml-auto">Clear selection</div>
    <label id="btnLoad" class="button button-minwidth">
      Load selection<input id="fileLoad" name="file" type="file" style="display: none;">
    </label>
    <div id="btnSubmitTop" class="button button-minwidth">Submit</div>
  </div>
  <div id="noasTables">
    loading...
  </div>
  <div class="mt-4">
    <div id="btnSubmit" class="button button-minwidth">Submit</div>
  </div>
  <div class="mb-5"></div>

<!-- enable pop-overs -->
<script>
  $(document).ready(function(){
    $('[data-toggle="popover"]').popover();
  });
</script>
<script>
  var g_cfg = {
    get_meta_url: '/dbmeta.php'
  };

  const g_prj = (function() {
    const prj = (new URLSearchParams(window.location.search)).get("prj");
    if (!prj) {
      window.location.href = './index.html';
    }
    document.getElementById("spPrj").innerHTML = prj;
    return prj;
  })();

  async function getMetaData() {
    async function _getData(url) {
      const response = await fetch(url, {
        method: 'GET'
      });
      if (!response.ok) {
        throw new Error(response.statusText);
      }
      return response.json();
    }
    try {
      let jsn = await _getData(g_cfg.get_meta_url);
      if (!jsn.status_ok) {
        throw Error(jsn.status_msg);
      }
      return jsn.data;
    } catch (e) {
      showAlertBox(AlertType.ERROR, ["Unable to load data.", e.toString()]);
      console.log("err: " + e.toString());
    };
    return {};
  }

  async function start() {
    const meta = await getMetaData();
    // set version
    {
      const vdateStr = (new Date(meta.version.ts)).toLocaleString();
      document.getElementById("version-label").innerHTML = `${meta.version.label} (${vdateStr})`;
      if (!meta.version.import_completed) {
        const errmsg = [ 
          `Either the last update of the database (${vdateStr}) had an error or the update has not finished yet.`,
          `The data shown here will be incomplete.`
        ];
        showAlertBox(AlertType.ERROR, errmsg);
      }
    }
    let eNoasTables = document.querySelector("#noasTables");
    eNoasTables.innerHTML = '';
    document.getElementById("version-id").innerHTML = `${meta.version.id}`;
    meta.tables.forEach((e,i) => {
      let eOptbox = document.createElement('div');
      eNoasTables.appendChild(eOptbox);
      eOptbox.classList.add("optbox");
      eOptbox.id = `noasTable_${e.id}`;
      // box header
      let eOpthead = document.createElement('div');
      eOptbox.appendChild(eOpthead);
      eOpthead.classList.add("opthead");
      let eOptheadTable = document.createElement('table');
      eOpthead.appendChild(eOptheadTable);
      let eOptheadTableTr = document.createElement('tr');
      eOptheadTable.appendChild(eOptheadTableTr);
      let eOptheadTableTd = document.createElement('td');
      eOptheadTableTr.appendChild(eOptheadTableTd);
      eOptheadTableTd.classList.add("optopener");
      let eArrow = document.createElement('i');
      eOptheadTableTd.append(eArrow);
      eArrow.classList.add("ddarrow");
      const strCategory = e.category ? `[${e.category}] ` : '';
      eOptheadTableTd.insertAdjacentHTML('beforeend',
        `${strCategory}${e.title} (${e.id}; n=${e.n})`
      );
      // open / close
      eOptheadTableTd.addEventListener('click', () => {
        eOptbody.classList.toggle('openoptbody');
        eArrow.classList.toggle('openddarrow');
      });
      // box body (columns)
      let eOptbody = document.createElement('div');
      eOptbox.appendChild(eOptbody);
      eOptbody.classList.add("optbody");
      let eOptcontent = document.createElement('div');
      eOptbody.appendChild(eOptcontent);
      eOptcontent.classList.add("optcontent");
      eOptcontent.classList.add("container");
      eOptcontent.classList.add("mx-1");
      // columns
      let eRow = document.createElement("div");
      eOptcontent.appendChild(eRow);
      eRow.classList.add("row");
      e.columns.forEach((ec,i) => {
        let eCol = document.createElement("div");
        eRow.appendChild(eCol);
        eCol.classList.add("col-sm-3");
        eCol.classList.add("mb-2");
        eCol.classList.add("form-group");
        eCol.classList.add("form-check");
        let eLabel = document.createElement("label");
        eCol.appendChild(eLabel);
        eLabel.classList.add("form-check-label");
        eLabel.classList.add("font-weight-normal");
        let eCheck = document.createElement("input");
        eLabel.appendChild(eCheck);
        eCheck.id = `colcheck_${e.id}_${ec.id}`;
        eCheck.type = 'checkbox';
        eCheck.classList.add("mr-3");
        eCheck.noasTableId = e.id;
        eCheck.noasColId = ec.id;
        eCheck.value = "1";
        eLabel.insertAdjacentHTML('beforeend', ec.title)
      });
      // select all button
      if (i > 0) {
        let eSelAll = document.createElement('a');
        eOptcontent.appendChild(eSelAll);
        eSelAll.classList.add("opt-selectall");
        eSelAll.classList.add("mt-2");
        const strSelAll = "Select all";
        const strUnselAll = "Unselect all";
        eSelAll.insertAdjacentHTML('beforeend', "Select all");
        eSelAll.addEventListener('click', (e) => {
          let doSel = e.srcElement.innerHTML == strSelAll;
          e.srcElement.innerHTML = doSel ? strUnselAll : strSelAll;
          eOptcontent.querySelectorAll("input").forEach(e => {
            e.checked = doSel;
          })
        });
      }
    });
    // query options
    let eOptbox = document.createElement('div');
    eNoasTables.appendChild(eOptbox);
    eOptbox.classList.add("optbox");
    eOptbox.id = `queryOpts`;
    // query options box header
    let eOpthead = document.createElement('div');
    eOptbox.appendChild(eOpthead);
    eOpthead.classList.add("opthead");
    let eOptheadTable = document.createElement('table');
    eOpthead.appendChild(eOptheadTable);
    let eOptheadTableTr = document.createElement('tr');
    eOptheadTable.appendChild(eOptheadTableTr);
    let eOptheadTableTd = document.createElement('td');
    eOptheadTableTr.appendChild(eOptheadTableTd);
    eOptheadTableTd.classList.add("optopener");
    let eArrow = document.createElement('i');
    eOptheadTableTd.append(eArrow);
    eArrow.classList.add("ddarrow");
    eOptheadTableTd.insertAdjacentHTML('beforeend', "Query Options");
    // query options open / close
    eOptheadTableTd.addEventListener('click', () => {
      eOptbody.classList.toggle('openoptbody');
      eArrow.classList.toggle('openddarrow');
    });
    // query options box body (columns)
    let eOptbody = document.createElement('div');
    eOptbox.appendChild(eOptbody);
    eOptbody.classList.add("optbody");
    let eOptcontent = document.createElement('div');
    eOptbody.appendChild(eOptcontent);
    eOptcontent.classList.add("optcontent");
    eOptcontent.classList.add("container");
    eOptcontent.classList.add("mx-1");
    [
      { id: "all",       text: "all visits (all n and many missing values)"},
      { id: "union",     text: "union of datasets"},
      { id: "intersect", text: "intersection of datasets (few n and few missing values)"},
    ].forEach((er,i) => {
      let eLabel = document.createElement("label");
      eOptcontent.appendChild(eLabel);
      let eRadio = document.createElement("input");
      eLabel.appendChild(eRadio);
      eRadio.id = er.id;
      eRadio.value = er.id;
      eRadio.type = 'radio';
      eRadio.name = "setOps";
      eRadio.classList.add("mr-3");
      eLabel.insertAdjacentHTML('beforeend', er.text)
      eOptcontent.appendChild(document.createElement('br'));
      eRadio.checked = i == 2; // preselect intersect 
    }); // end query options

    // preselect some cols
    let ecbcsubj = document.querySelector("#colcheck_core_subject_id");
    ecbcsubj.checked = true;
    ecbcsubj.disabled = true;
    document.querySelector("#colcheck_core_project_id").checked = true;
    document.querySelector("#colcheck_core_wave_code").checked = true;
    document.querySelector("#colcheck_core_subject_sex").checked  = true;
    // open default boxes
    document.querySelector("#noasTable_core td").click();
    document.querySelector("#queryOpts td").click();
  }

  // clear selection
  function clearSelection() {
    document.querySelectorAll("[id^='colcheck_']").forEach(e => e.checked = false);
    // check subjid
    document.querySelector("#colcheck_core_subject_id").checked = true;
  }

  function getSelection() {
    let sel = {
      columns: [],
      set_op: null,
      date: (new Date()).toISOString(),
      version: document.getElementById("version-id").innerHTML,
    };
    // get selected columns
    let cbs = document.querySelectorAll("[id^='colcheck_']");
    cbs.forEach(e => {
      if (!e.checked) {
        return;
      }
      sel.columns.push({table_id: e.noasTableId, column_id: e.noasColId});
    });
    sel.project = g_prj;
    // query options
    sel.set_op = document.querySelector('input[name="setOps"]:checked').value;
    return sel;
  }
  
  async function loadSelection() {
    try {
      // read json
      var file = document.getElementById('fileLoad').files[0];
      if (file === undefined) {
        throw new Error("undefined file");
      }
      var reader = new FileReader();
      reader.readAsText(file, 'UTF-8');
      const data = await new Response(file).text()
      let selection = JSON.parse(data);
      if (selection.project != g_prj) {
        throw new Error(`Incompatible selections - Project in file is "${selection.project}"`);
      }
      // clear
      clearSelection();
      // apply selection
      let idsNotFound = [];
      // column checkboxes
      selection.columns.forEach(e => {
        let checkid = `colcheck_${e.table_id}_${e.column_id}`;
        let cb = document.getElementById(checkid);
        if (!cb) {
          idsNotFound.push(e);
          return;
        }
        cb.checked = true;
      });
      // query options
      document.querySelectorAll('input[name="setOps"]').forEach(e => {
        e.checked = e.value == selection.set_op;
      });
      if (idsNotFound.length > 0) {
        let errmsg = [`While loading selections from "${file.name}", these entries were not found in current NOAS:`];
        idsNotFound.forEach( e => {
          errmsg.push(`table "${e.table_id}", column "${e.column_id}"`);
        });
        showAlertBox(AlertType.WARNING, errmsg);
        return;
      }
    } catch (e) {
      showAlertBox(AlertType.ERROR, ["Unable to load selection.", e.toString()]);
      console.log("err: " + e.toString());
      return;
    };
    showAlertBox(AlertType.OK, "Loaded data selection: " + file.name);
  }

  function submitSelection() {
    const sel = getSelection();
    // save inside browser session to pass it to next page
    window.sessionStorage.setItem('selection', JSON.stringify(sel));
    // open result page
    window.location.href = `./results.html?prj=${g_prj}`;
  }

  document.getElementById("btnClear").addEventListener('click', clearSelection);
  document.getElementById("btnLoad").addEventListener('change', loadSelection);
  document.getElementById("btnSubmit").addEventListener('click', submitSelection);
  document.getElementById("btnSubmitTop").addEventListener('click', submitSelection);
  
  start();

</script>
</body>
</html>