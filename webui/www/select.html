<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<link rel="shortcut icon" href="./img/favicon.ico">
<link rel="stylesheet" href="./css/layout.css" type="text/css"/>
<link rel="stylesheet" href="./css/bootstrap.min.css" type="text/css"/>
<link rel="stylesheet" href="./css/bootstrap.css" type="text/css"/>
<link rel="stylesheet" href="./css/optbox.css" type="text/css"/>
<script type="text/javascript" src="./js/solid.min.js" ></script>
<script type="text/javascript" src="./js/fontawesome.min.js"></script>
<script type="text/javascript" src="./js/jquery.min.js"></script>
<script type="text/javascript" src="./js//popper.min.js"></script>
<script type="text/javascript" src="./js/bootstrap.min.js"></script>

<title>
NOAS - Query selector
</title>
</head>
<body>
  
  <nav class="navbar navbar-expand navbar-dark">
    <a class="navbar-brand font-weight-bold" href="/">
      NOAS
    </a>
  </nav>

  <div class="container">
    <div id="alerts"></div>
  </div>
  <div class="d-flex">
    <div class="h4 mt-1">
      Database Query
      <a href="#" data-toggle="popover" data-trigger="focus" title="Help"
        data-content="Select the data you are interested in and press 'Submit' (bottom).">
        <i class="bluehover fas fa-question-circle" aria-hidden="true"></i>
      </a>
    </div>
    <div id="btnClear" class="button button-minwidth ml-auto">Clear selection</div>
    <div id="btnSave" class="button button-minwidth">Save selection</div>
    <label id="btnLoad" class="button button-minwidth">
      Load selection<input id="fileLoad" name="file" type="file" style="display: none;">
    </label>
  </div>
  <div id="noasTables">
    loading...
  </div>
  <div class="mt-4">
    <div id="submit" class="button button-minwidth">Submit</div>
  </div>
  <div class="mb-5"></div>

<!-- enable popovers -->
<script>
  $(document).ready(function(){
    $('[data-toggle="popover"]').popover();
  });
</script>
<script>
// bootstrap alerts
const AlertType = {
  ERROR:   {id: "error",   bsClass: "alert-danger"},
  OK:      {id: "ok",      bsClass: "alert-success"},
  WARNING: {id: "warning", bsClass: "alert-warning"},
}
function showAlertBox(alertType, msgs) {
  let epar = document.querySelector('#alerts');
  let en = document.createElement('div');
  epar.appendChild(en);
  en.classList.add('alert');
  en.classList.add(alertType.bsClass);
  en.classList.add('alert-dismissible');
  en.classList.add('mt-1');
  let ea = document.createElement('a');
  en.appendChild(ea);
  ea.classList.add("close");
  ea.classList.add("p-0");
  ea.setAttribute("data-dismiss", "alert");
  ea.innerHTML = "&times";
  en.insertAdjacentHTML('beforeend', [].concat(msgs).join("<br>"));
}
</script>
<script>
  var g_cfg = {
    get_meta_url: '/dbmeta.php'
  };

  async function getMetaData(mdAlert, dateMin) {
    async function _getData(url) {
      const response = await fetch(url, {
        method: 'GET'
      });
      if (!response.ok) {
        throw new Error(response.statusText);
      }
      return response.json();
    }
    try {
      let jsn = await _getData(g_cfg.get_meta_url);
      if (!jsn.status_ok) {
        throw Error(jsn.status_msg);
      }
      return jsn.data;
    } catch (e) {
      showAlertBox(AlertType.ERROR, ["Unable to load data.", e.toString()]);
      console.log("err: " + e.toString());
    };
    return {};
  }

  async function start() {
    const meta = await getMetaData();
    let eNoasTables = document.querySelector("#noasTables");
    eNoasTables.innerHTML = '';
    meta.tables.forEach((e,i) => {
      let eOptbox = document.createElement('div');
      eNoasTables.appendChild(eOptbox);
      eOptbox.classList.add("optbox");
      eOptbox.id = `noasTable_${e.id}`;
      // box header
      let eOpthead = document.createElement('div');
      eOptbox.appendChild(eOpthead);
      eOpthead.classList.add("opthead");
      let eOptheadTable = document.createElement('table');
      eOpthead.appendChild(eOptheadTable);
      let eOptheadTableTr = document.createElement('tr');
      eOptheadTable.appendChild(eOptheadTableTr);
      let eOptheadTableTd = document.createElement('td');
      eOptheadTableTr.appendChild(eOptheadTableTd);
      eOptheadTableTd.classList.add("optopener");
      let eArrow = document.createElement('i');
      eOptheadTableTd.append(eArrow);
      eArrow.classList.add("ddarrow");
      const strCategory = e.category ? `[${e.category}] ` : '';
      eOptheadTableTd.insertAdjacentHTML('beforeend',
        `${strCategory}${e.title} (${e.id}; n=${e.n})`
      );
      // open / close
      eOptheadTableTd.addEventListener('click', () => {
        eOptbody.classList.toggle('openoptbody');
        eArrow.classList.toggle('openddarrow');
      });
      // box body (columns)
      let eOptbody = document.createElement('div');
      eOptbox.appendChild(eOptbody);
      eOptbody.classList.add("optbody");
      let eOptcontent = document.createElement('div');
      eOptbody.appendChild(eOptcontent);
      eOptcontent.classList.add("optcontent");
      eOptcontent.classList.add("container");
      eOptcontent.classList.add("mx-1");
      // columns
      let eRow = document.createElement("div");
      eOptcontent.appendChild(eRow);
      eRow.classList.add("row");
      e.cols.forEach((ec,i) => {
        let eCol = document.createElement("div");
        eRow.appendChild(eCol);
        eCol.classList.add("col-sm-3");
        eCol.classList.add("mb-2");
        eCol.classList.add("form-group");
        eCol.classList.add("form-check");
        let eLabel = document.createElement("label");
        eCol.appendChild(eLabel);
        eLabel.classList.add("form-check-label");
        eLabel.classList.add("font-weight-normal");
        let eCheck = document.createElement("input");
        eLabel.appendChild(eCheck);
        eCheck.id = `colcheck_${e.id}_${ec.id}`;
        eCheck.type = 'checkbox';
        eCheck.classList.add("mr-3");
        eCheck.noasTableId = e.id;
        eCheck.noasColId = ec.id;
        eCheck.value = "1";
        eLabel.insertAdjacentHTML('beforeend', ec.title)
      });
      // select all button
      if (i > 0) {
        let eSelAll = document.createElement('a');
        eOptcontent.appendChild(eSelAll);
        eSelAll.classList.add("opt-selectall");
        eSelAll.classList.add("mt-2");
        const strSelAll = "Select all";
        const strUnselAll = "Unselect all";
        eSelAll.insertAdjacentHTML('beforeend', "Select all");
        eSelAll.addEventListener('click', (e) => {
          let doSel = e.srcElement.innerHTML == strSelAll;
          e.srcElement.innerHTML = doSel ? strUnselAll : strSelAll;
          eOptcontent.querySelectorAll("input").forEach(e => {
            e.checked = doSel;
          })
        });
      }
    });
    // query options
    let eOptbox = document.createElement('div');
    eNoasTables.appendChild(eOptbox);
    eOptbox.classList.add("optbox");
    eOptbox.id = `queryOpts`;
    // query options box header
    let eOpthead = document.createElement('div');
    eOptbox.appendChild(eOpthead);
    eOpthead.classList.add("opthead");
    let eOptheadTable = document.createElement('table');
    eOpthead.appendChild(eOptheadTable);
    let eOptheadTableTr = document.createElement('tr');
    eOptheadTable.appendChild(eOptheadTableTr);
    let eOptheadTableTd = document.createElement('td');
    eOptheadTableTr.appendChild(eOptheadTableTd);
    eOptheadTableTd.classList.add("optopener");
    let eArrow = document.createElement('i');
    eOptheadTableTd.append(eArrow);
    eArrow.classList.add("ddarrow");
    eOptheadTableTd.insertAdjacentHTML('beforeend', "Query Options");
    // query options open / close
    eOptheadTableTd.addEventListener('click', () => {
      eOptbody.classList.toggle('openoptbody');
      eArrow.classList.toggle('openddarrow');
    });
    // query options box body (columns)
    let eOptbody = document.createElement('div');
    eOptbox.appendChild(eOptbody);
    eOptbody.classList.add("optbody");
    let eOptcontent = document.createElement('div');
    eOptbody.appendChild(eOptcontent);
    eOptcontent.classList.add("optcontent");
    eOptcontent.classList.add("container");
    eOptcontent.classList.add("mx-1");
    [
      { id: "all",       text: "all visits (all n and many missing values)"},
      { id: "union",     text: "union of datasets"},
      { id: "intersect", text: "intersection of datasets (few n and few missing values)"},
    ].forEach((er,i) => {
      let eLabel = document.createElement("label");
      eOptcontent.appendChild(eLabel);
      let eRadio = document.createElement("input");
      eLabel.appendChild(eRadio);
      eRadio.id = er.id;
      eRadio.value = er.id;
      eRadio.type = 'radio';
      eRadio.name = "setOps";
      eRadio.classList.add("mr-3");
      eLabel.insertAdjacentHTML('beforeend', er.text)
      eOptcontent.appendChild(document.createElement('br'));
      eRadio.checked = i == 2; // preselect intersect 
    }); // end query options

    // preselect some cols
    let ecbcsubj = document.querySelector("#colcheck_core_subject_id");
    ecbcsubj.checked = true;
    ecbcsubj.disabled = true;
    document.querySelector("#colcheck_core_project_id").checked = true;
    document.querySelector("#colcheck_core_wave_code").checked = true;
    document.querySelector("#colcheck_core_subject_sex").checked  = true;
    // open default boxes
    document.querySelector("#noasTable_core td").click();
    document.querySelector("#queryOpts td").click();
  }

  // clear selection
  function clearSelection() {
    document.querySelectorAll("[id^='colcheck_']").forEach(e => e.checked = false);
    // check subjid
    document.querySelector("#colcheck_core_subject_id").checked = true;
  }

  function getSelection() {
    let sel = {
      columns: [],
      set_op: null,
      date: new Date(),
    };
    // get selected columns
    let cbs = document.querySelectorAll("[id^='colcheck_']");
    cbs.forEach(e => {
      if (!e.checked) {
        return;
      }
      sel.columns.push({table_id: e.noasTableId, column_id: e.noasColId});
    });
    // query options
    sel.set_op = document.querySelector('input[name="setOps"]:checked').value;
    return sel;
  }
  
  // save selection
  function saveSelecion() {
    const sel = getSelection();
    const d = sel.date;
    const dyr = new Intl.DateTimeFormat('en', { year:   'numeric' }).format(d);
    const dmo = new Intl.DateTimeFormat('en', { month:  '2-digit' }).format(d);  
    const ddy = new Intl.DateTimeFormat('en', { day:    '2-digit' }).format(d);  
    let dhr = new Intl.DateTimeFormat('en', { hour:   '2-digit', hour12: false}).format(d);  
    let dmi = new Intl.DateTimeFormat('en', { minute: '2-digit' }).format(d);  
    let dsc = new Intl.DateTimeFormat('en', { second: '2-digit' }).format(d);
    // h, m, s won't be zero-padded, we have to fix this
    dhr = dhr.padStart(2, '0');
    dmi = dmi.padStart(2, '0');
    dsc = dsc.padStart(2, '0');
    fileName = `noas_selection_${dyr}-${dmo}-${ddy}_${dhr}-${dmi}-${dsc}.json`;
    let json = JSON.stringify(sel, null, 2);
    let file = new File([json], fileName, {type: "octet/stream"});
    let exportUrl = URL.createObjectURL(file);
    window.location.assign(exportUrl);
    URL.revokeObjectURL(exportUrl);
  }

  async function loadSelection() {
    try {
      // read json
      var file = document.getElementById('fileLoad').files[0];
      if (file === undefined) {
        throw new Error("undefined file");
      }
      var reader = new FileReader();
      reader.readAsText(file, 'UTF-8');
      const data = await new Response(file).text()
      let selection = JSON.parse(data);
      // clear
      clearSelection();
      // apply selection
      let idsNotFound = [];
      // column checkboxes
      selection.columns.forEach(e => {
        let checkid = `colcheck_${e.table_id}_${e.column_id}`;
        let cb = document.getElementById(checkid);
        if (!cb) {
          idsNotFound.push(e);
          return;
        }
        cb.checked = true;
      });
      // query options
      document.querySelectorAll('input[name="setOps"]').forEach(e => {
        e.checked = e.value == selection.set_op;
      });
      if (idsNotFound.length > 0) {
        let errmsg = [`While loading selections from "${file.name}", these entries were not found in current NOAS:`];
        idsNotFound.forEach( e => {
          errmsg.push(`table "${e.table_id}", column "${e.column_id}"`);
        });
        showAlertBox(AlertType.WARNING, errmsg);
        return;
      }
    } catch (e) {
      showAlertBox(AlertType.ERROR, ["Unable to load selection.", e.toString()]);
      console.log("err: " + e.toString());
      return;
    };
    showAlertBox(AlertType.OK, "Loaded data selection: " + file.name);
  }

  document.querySelector("#btnClear").addEventListener('click', clearSelection);
  document.querySelector("#btnSave").addEventListener('click', saveSelecion);
  document.querySelector("#btnLoad").addEventListener('change', loadSelection);
  
  start();

</script>
</body>
</html>