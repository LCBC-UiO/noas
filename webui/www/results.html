<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<link rel="shortcut icon" href="./img/favicon.ico">
<link rel="stylesheet" href="./css/layout.css" type="text/css"/>
<link rel="stylesheet" href="./css/bootstrap.min.css" type="text/css"/>
<link rel="stylesheet" href="./css/bootstrap.css" type="text/css"/>
<link rel="stylesheet" href= "./css/optbox.css" type="text/css"/>
<link  rel="stylesheet" href="./css/tabulator_lcbc.css" type="text/css">
<script type="text/javascript" src="./js/xlsx.full.min.js"></script>
<script type="text/javascript" src="./js/tabulator.min.js"></script>
<script type="text/javascript" src="./js/lcalerts.js"></script>
<script type="text/javascript" src="./js/lchelper.js"></script>
<script type="text/javascript" src="./js/jquery.min.js"></script>
<script type="text/javascript" src="./js//popper.min.js"></script>
<script type="text/javascript" src="./js//bootstrap.min.js"></script>
<script type="text/javascript" src="./js/solid.min.js" ></script>
<script type="text/javascript" src="./js/fontawesome.min.js"></script>

<title>
  NOAS - Query results
</title>
</head>
<body>
    
  <nav class="navbar navbar-expand navbar-dark">
    <a class="navbar-brand font-weight-bold" href="./index.html">
      <script language="JavaScript">
        var request = new XMLHttpRequest()
        request.open('GET', './static_info.json', false); 
        request.send(null);
        if (request.status === 200) {
          document.write(JSON.parse(request.responseText).instance_name);
        }
      </script>
    </a>
    <span class="navbar-text" id="version-label">&nbsp;</span>
    <a class="ml-auto" href="./index.html">
      <span class="navbar-text">Project:</span>
      <span class="navbar-text ml-1" id="spPrj"></span>
    </a>
  </nav>

  <div class="container">
    <div id="alerts"></div>
  </div>
  <div class="d-flex">
    <div class="h4 mt-1">
      Database Results
    </div>
    <div id="btnSave" class="button button-minwidth ml-auto">Save selection</div>
    <div id="btnDlCsv" class="button button-minwidth">Download CSV</div>
    <div id="btnDlXlsx" class="button button-minwidth">Download Excel</div>
    <div type="button" class="button button-minwidth" data-toggle="modal" data-target="#modalImportR">Import to R</div>
    <div id="btnBack" class="button button-minwidth">Back</div>
  </div>
  <div id="noasTable" class="mt-2"></div>
  <div class="mb-5"></div>

  <div class="modal" id="modalImportR">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Copy&paste into R</h4>
          <span data-toggle="tooltip" data-placement="top" title="Copy to clipboard">
            <button id="btnCopyR" type="button" class="ml-4 btn" data-dismiss="modal">
              <span class="fas fa-copy fa-lg"></span> 
            </button>
          </span>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body"><code id="codeImportR" style="white-space: pre-wrap;"></code></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
        </div>
  
      </div>
    </div>
  </div>

  <script>
    var g_table = null;

    async function getTableData(selection) {
      async function _getData(url) {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
          'Content-Type': 'application/json'
          },
          body: JSON.stringify(selection),
        });
        if (!response.ok) {
          throw new Error(response.statusText);
        }
        return response.json();
      }
      let jsn = await _getData("./query_json.php");
      if (!jsn.status_ok) {
        throw Error(jsn.status_msg);
      }
      return jsn.data;
    }


    function getColDef(coldefs) {
      let colCalcN = function(values, data, calcParams) {
        return "n=" + values.length.toString();
      }
      let colCalcAvg = function(values, data, calcParams){
        values = values.filter(e => e !== null);
        const mean = values.reduce( (a,b) => a + parseFloat(b), 0) / values.length;
        return "avg=" + (mean).toPrecision(4);
      }
      let colCalcAvgSd = function(values, data, calcParams){
        values = values.filter(e => e !== null);
        const n = values.length
        const mean = values.reduce( (a,b) => a + parseFloat(b), 0) / n;
        const sd = Math.sqrt(values.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / n)
        return `avg=${mean.toPrecision(3)};SD=${sd.toPrecision(3)}`;
      }
      return coldefs.map( e => {
        let r = {
          title: e.id,
          field: e.id,
          minWidth: 90
        }
        if (e.idx == 0) {
          r.topCalc = colCalcN;
          r.bottomCalc = colCalcN;
          r.minWidth = 120;
        } else if (e.type == "float" || e.type == "int") {
          r.topCalc = colCalcAvgSd;
          r.bottomCalc = colCalcAvgSd;
          r.sorter = "number";
        }
        return r;
      });
    };

    function getSelection() {
      try {
        const storage = window.sessionStorage.getItem('selection');
        if (!storage) {
          throw new Error("Session expired - Please select columns <a href='./select.html'>here</b></a>.")
        }
        const sel = JSON.parse(storage);
        return sel;
       } catch (e) {
        showAlertBox(AlertType.ERROR, ["Unable to get selected data.", e.toString()]);
        console.log("err: " + e.toString());
      }
    }

    async function loadTable() {
      try {
        const sel = getSelection();
        lcProgressInit("noasTable");
        // make db query
        g_table_data = await getTableData(sel);
        document.getElementById("noasTable").innerHTML = '<br><br><h4>preparing table...</h4>';
        document.getElementById("spPrj").innerHTML = sel.project;

        // show data in table
        g_table = new Tabulator("#noasTable", {
          layout: "fitColumns", 
          pagination: "local",
          paginationSize: 25,
          columns: getColDef(g_table_data.column_def),
          downloadConfig: {
            columnCalcs: false,
          },
          data: g_table_data.rows,
          /* replace null elements with empty string */
          downloadDataFormatter:function(data){
            data = JSON.parse(JSON.stringify(data).replace(/null/g, '""'))
            return data
          }
        });
        // load "import to r" code
        document.getElementById("codeImportR").innerHTML = await (async function() {
          r = await fetch("./r_import_txt.php", { 
            method: "POST",
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(sel),
          });
          if (!r.ok) {
            throw `error loading from r_import_txt.php`;
          }
          return await r.text();
        })();
      } catch (e) {
        showAlertBox(AlertType.ERROR, ["Unable to get table data.", e.toString()]);
        console.log("err: " + e.toString());
      }
    }

    loadTable();

    document.getElementById("btnSave").addEventListener('click', () => lcSaveSelection(getSelection()));
    document.getElementById("btnDlCsv").addEventListener('click', function() {
      const sel = getSelection();
      const md5 = lcGetSelHash(sel)
      const did = lcGetDataVersionFnStr(sel);
      const dlfilename = `noas_query_${lcGetDateFnStr(Date.parse(g_table_data.date))}_${md5}_${did}.csv`;
      g_table.download("csv", dlfilename, {delimiter:";"});
    });
    document.getElementById("btnDlXlsx").addEventListener('click', function() {
      const sel = getSelection();
      const md5 = lcGetSelHash(sel);
      const did = lcGetDataVersionFnStr(sel);
      const dlfilename = `noas_query_${lcGetDateFnStr(Date.parse(g_table_data.date))}_${md5}_${did}.xlsx`;
      g_table.download("xlsx", dlfilename, {sheetName:`NOAS download ${md5} ${did}`});
    });
    document.getElementById("btnCopyR").onclick = (e) => {
      let ec = document.getElementById("codeImportR");
      navigator.clipboard.writeText(ec.innerText);
    }
    document.getElementById("btnBack").addEventListener('click', () => {history.back()});
    
    // enable bs tooltips
    $('[data-toggle="tooltip"]').tooltip({ boundary: 'window' });
  </script>
</body>
