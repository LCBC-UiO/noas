<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
  <link rel="shortcut icon" href="./img/favicon.ico">
  <link rel="stylesheet" href="./css/bootstrap.min.css" type="text/css"/>
  <link rel="stylesheet" href="./css/tabulator.min.css" type="text/css"/>
  <link rel="stylesheet" href="./css/tabulator_bs5.min.css" type="text/css"/>
  <link rel="stylesheet" href="./css/noas_selector_search.css" type="text/css"/>
  <link rel="stylesheet" href="./css/noas_selector_tree.css" type="text/css"/>
  <link rel="stylesheet" href="./css/layout.css" type="text/css"/>
  <script type="text/javascript" src="./js/tabulator.min.js"></script>
  <script type="text/javascript" src="./js/solid.min.js" ></script>
  <script type="text/javascript" src="./js/fontawesome.min.js"></script>
  <script type="text/javascript" src="./js/d3.v6.min.js"></script>
  <script type="text/javascript" src="./js/fuse-6.4.6.js"></script>
  <script type="text/javascript" src="./js/jquery.min.js"></script>
  <script type="text/javascript" src="./js//popper.min.js"></script>
  <script type="text/javascript" src="./js/bootstrap.min.js"></script>
  <script type="text/javascript" src="./js/noas_selector_base.js"></script>
  <script type="text/javascript" src="./js/lcalerts.js"></script>
  <script type="text/javascript" src="./js/lchelper.js"></script>
<title>
  NOAS - Query results
</title>
</head>
<body>
    
  <nav class="navbar navbar-expand navbar-dark bg-dark p-4 ">
    <div class="container-fluid">
      <a class="navbar-brand font-weight-bold p-2" href="./index.html">
        <img src="img/favicon.ico" width="30" height="30" alt="">
        <script language="JavaScript">
          var request = new XMLHttpRequest()
          request.open('GET', './static_info.json', false); 
          request.send(null);
          if (request.status === 200) {
            document.write(JSON.parse(request.responseText).instance_name);
          }
        </script>
      </a>
      <div>
        <div class="container justify-content-end">
          <p class="navbar-text" id="version-label"></p>
          <a href="./index.html">
            <p class="navbar-text">Project:
              <span id="spPrj"></span>
            </p>
          </a>
        </div>
    </div>
  </nav>

  <div class="container">
    <div id="alerts"></div>
  </div>

  <div class="container">
    <h4 class="text-left my-4">Database Results</h4>
    <div class="d-flex  align-items-center justify-content-between">
      <div id="btnSave" class="btn btn-primary">Save selection</div>
      <div id="btnDlCsv" class="btn btn-primary">Download CSV</div>
      <div id="btnDlXlsx" class="btn btn-primary">Download Excel</div>
      <div type="button" class="btn btn-primary" data-toggle="modal" data-target="#modalExportR" id="btnModalEncR">Download R</div>
      <div type="button" class="btn btn-primary" data-toggle="modal" data-target="#modalImportR">Import to R</div>
      <div id="btnBack" class="btn btn-primary">Back</div>
    </div>

  <div id="noasTable" class="table table-sm table-striped table-responsive fw"></div>

  <div class="modal" id="modalImportR">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Copy&paste into R</h4>
          <span data-toggle="tooltip" data-placement="top" title="Select all">
            <button id="btnMarkAllR" type="button" class="ml-4 btn">
              <span class="fas fa-paint-roller fa-lg"></span> 
            </button>
          </span>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body"><code id="codeImportR" style="white-space: pre-wrap;"></code></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modalExportR">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Download encrypted .R file</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          <p>This file contains the password-protected data for safe and easy use outside of TSD.</p>
          <hr>
          <div class="row px-5">
            <div class="col-lg-7">
              <span class="h4 text-muted">data ID:</span>
              <span class="h4 text-muted" id="spExportRId">cc59fb2_9a02e6f</span>
              <div class="mt-3"></div>
              <span class="h4 text-muted">password:</span>
              <span class="display-4 text-monospace" id="spExportRPw"></span>
            </div>
            <div class="col-lg-5 mt-3">
              <button type="button" class="btn btn-lg btn-secondary" id="btnDlEncR">Download encrypted .R file</button>
              <div id="dProgress" class="progress w-100">
                <div class="progress-bar progress-bar-striped progress-bar-animated w-100">
                  preparing download...
                </div>
              </div>
              <!-- hidden download link, will get clicked by js -->
              <a class="hidden" id="aDlEncR"></a>
            </div>
          </div>
          <hr>
          <div class="text-muted">
            <p>
              Instructions:
              <ol>
                <li>Take a picture of the password with your phone or write it down.*</li>
                <li>Download the .R file.</li>
                <li>Export the .R file from TSD to your local computer.</li>
                <li>Load the .R file from R.<br> Example: <code id="codeExportRSource"></code></li>
                <li>Enter the password from above.</li>
                <li>Your sensitive data is loaded into R.</li>
              </ol>
            </p>
            <p>*) Do NOT store the password and the encrypted .R file on the same device. (Don't take a screenshot. Don't take a picture, if it is getting synced to your PC.)</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>

    var g_table = null;

    async function getTableData(selection) {
      const response = await fetch("./query_json.php", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(selection),
      });
      if (!response.ok) {
        throw new Error(response.statusText);
      }
      const jsn = await response.json();
      if (!jsn.status_ok) {
        throw Error(jsn.status_msg);
      }
      return jsn.data;
    }


    function getColDef(coldefs) {
      let colCalcN = function(values, data, calcParams) {
        return "n=" + values.length.toString();
      }
      let colCalcAvg = function(values, data, calcParams){
        values = values.filter(e => e !== null);
        const mean = values.reduce( (a,b) => a + parseFloat(b), 0) / values.length;
        return "m=" + (mean).toPrecision(4);
      }
      let colCalcAvgSd = function(values, data, calcParams){
        values = values.filter(e => e !== null);
        const n = values.length;
        const mean = values.reduce( (a,b) => a + parseFloat(b), 0) / n;
        const sd = Math.sqrt(values.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / n);
        return `m=${mean.toPrecision(2)} sd=${sd.toPrecision(2)}`;
      }
      return coldefs.map( e => {
        let r = {
          title: e.id,
          field: e.id,
          minWidth: 90
        }
        if (e.idx == 0) {
          r.topCalc = colCalcN;
          r.bottomCalc = colCalcN;
          r.minWidth = 120;
        } else if (e.type == "float" || e.type == "int") {
          r.topCalc = colCalcAvgSd;
          r.bottomCalc = colCalcAvgSd;
          r.sorter = "number";
        }
        return r;
      });
    };

    function getDataSelection() {
      try {
        const storage = window.sessionStorage.getItem('selection');
        if (!storage) {
          throw new Error("Session expired - Please select columns <a href='./select.html'>here</b></a>.")
        }
        const sel = JSON.parse(storage);
        return sel;
       } catch (e) {
        showAlertBox(AlertType.ERROR, ["Unable to get selected data.", e.toString()]);
        console.log("err: " + e.toString());
      }
    }

    function checkSelection(sel_cols) {
      const dbmeta = JSON.parse(window.sessionStorage.getItem('dbmeta'));
      // get table.type and repeated_group info from selections
      const selected_tables = [...new Set(sel_cols.map(c => c.table_id))];
      const r_goups = {};
      const r_ungrouped = [];
      dbmeta.tables.forEach(t => {
        // selected?
        if (!selected_tables.includes(t.id)) {
          return;
        }
        if (t.sampletype != "repeated") {
          return;
        }
        if (t.repeated_group) {
          if (!r_goups.hasOwnProperty(t.repeated_group.group_id)) {
            r_goups[t.repeated_group.group_id] = [];
          }
          r_goups[t.repeated_group.group_id].push(t.id);
        } else {
          r_ungrouped.push(t.id);
        }
      });
      const max_repeated = 2;
      if (Object.keys(r_goups).length + r_ungrouped.length > max_repeated) {
        const msg = [`You selected more than ${max_repeated} tables with timeseries data. NOAS will try to process your query but might fail due to the number of resulting rows. Here is a list of the problematic tables in your selection:`];
        let count = 1;
        Object.keys(r_goups).forEach(k => {
          if (r_goups[k].length > 1) {
            msg.push(`${count}) group "${k}" (tables: ${r_goups[k].join(", ")})`);
          } else {
            msg.push(`${count}) table "${r_goups[k].join(", ")}"`);
          }
          count++;
        });
        r_ungrouped.forEach(e => {
          msg.push(`${count}) table "${e}"`);
          count++;
        })
        showAlertBox(AlertType.WARNING, msg);
      }
    }

    async function loadTable() {
      try {
        const sel = getDataSelection();
        checkSelection(sel.columns);
        lcProgressInit("noasTable");
        // make db query
        g_table_data = await getTableData(sel);
        document.getElementById("noasTable").innerHTML = '<br><br><h4>preparing table...</h4>';
        document.getElementById("spPrj").innerHTML = sel.project;

        // show data in table
        g_table = new Tabulator("#noasTable", {
          layout: "fitDataFill", 
          pagination: "local",
          paginationSize: 25,
          columns: getColDef(g_table_data.column_def),
          downloadConfig: {
            columnCalcs: false,
          },
          data: g_table_data.rows,
          /* replace null elements with empty string */
          downloadDataFormatter: function(data){
            data = JSON.parse(JSON.stringify(data).replace(/null/g, '""'))
            return data
          },
          tooltipsHeader: true,
          tooltips: true,
        });
        // load "import to r" code
        document.getElementById("codeImportR").innerHTML = await (async function() {
          r = await fetch("./r_import.php", { 
            method: "POST",
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(sel),
          });
          if (!r.ok) {
            throw `error loading from r_import_txt.php`;
          }
          return await r.text();
        })();
        // encrypted R
        {
          const sel = getDataSelection();
          const md5 = lcGetSelHash(sel);
          const did = lcGetDataVersionFnStr(sel);
          const dat = lcGetDateFnStr(Date.parse(g_table_data.date));
          const dlfn = `noas_enc_${dat}_${md5}_${did}.R`;
          document.getElementById("spExportRId").innerHTML = `${dat}_${md5}_${did}`;
          document.getElementById("codeExportRSource").innerHTML = `source("~/Downloads/${dlfn}")`;
          // set password
          const password = (function(){
            /* https://stackoverflow.com/questions/2450954/how-to-randomize-shuffle-a-javascript-array */
            function _shuffleArray(array) {
              for (var i = array.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = array[i];
                array[i] = array[j];
                array[j] = temp;
              }
              return array;
            }
            const tokens = [
              "abcdefghijkmnopqrstuvwxyz",
              "ABCDEFGHJKLMNOPQRSTUVWXYZ",
              "0123456789",
              "-/?!+*"
            ];
            const lengths = [3,3,2,2]; // number of tokens from each group
            return _shuffleArray(
              tokens
                .map(e => e+e+e)
                .map(e => _shuffleArray(e.split("")))
                .map((e,i) => e.slice(0, lengths[i]))
                .flat()
            ).join("");
          })();
          document.getElementById("spExportRPw").innerHTML = password;
          // download button
          document.getElementById("btnDlEncR").onclick = async () => {
            document.getElementById("dProgress").classList.remove("hidden");
            document.getElementById("btnDlEncR").classList.add("hidden");
            const r = await fetch(`r_enc.php?password=${encodeURIComponent(password)}`, {
              method: "POST",
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(sel),
            });
            // rewrite the blobs content-type
            let blob = new Blob([await (await r.blob()).arrayBuffer()], {type : 'application/octet-stream'});
            let edlr = document.getElementById("aDlEncR");
            edlr.download = dlfn;
            edlr.href = window.URL.createObjectURL(blob);
            document.getElementById("dProgress").classList.add("hidden");
            document.getElementById("btnDlEncR").classList.remove("hidden");
            edlr.click();
          }
        }
      } catch (e) {
        showAlertBox(AlertType.ERROR, ["Unable to get table data.", e.toString()]);
        console.log("err: " + e.toString());
      }
    }

    loadTable();
    get_version();

    document.getElementById("btnSave").addEventListener('click', () => lcSaveSelection(getDataSelection()));
    document.getElementById("btnDlCsv").addEventListener('click', function() {
      const sel = getDataSelection();
      const md5 = lcGetSelHash(sel)
      const did = lcGetDataVersionFnStr(sel);
      const dlfilename = `noas_query_${lcGetDateFnStr(Date.parse(g_table_data.date))}_${md5}_${did}.csv`;
      g_table.download("csv", dlfilename, {delimiter:";"});
    });
    document.getElementById("btnDlXlsx").addEventListener('click', function() {
      const sel = getDataSelection();
      const md5 = lcGetSelHash(sel);
      const did = lcGetDataVersionFnStr(sel);
      const dlfilename = `noas_query_${lcGetDateFnStr(Date.parse(g_table_data.date))}_${md5}_${did}.xlsx`;
      g_table.download("xlsx", dlfilename, {sheetName:`NOAS download ${md5} ${did}`});
    });
    document.getElementById("btnModalEncR").onclick = (e) => {
      document.getElementById("btnDlEncR").classList.remove("hidden");
      document.getElementById("dProgress").classList.add("hidden");
    };
    document.getElementById("btnMarkAllR").onclick = (e) => {
      window.getSelection().selectAllChildren(
        document.getElementById("codeImportR") 
      );
    };
    document.getElementById("btnBack").addEventListener('click', () => {history.back()});
  </script>
</body>
