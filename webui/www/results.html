<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<link rel="shortcut icon" href="./img/favicon.ico">
<link rel="stylesheet" href="./css/layout.css" type="text/css"/>
<link rel="stylesheet" href="./css/bootstrap.min.css" type="text/css"/>
<link rel="stylesheet" href="./css/bootstrap.css" type="text/css"/>
<link rel="stylesheet" href= "./css/optbox.css" type="text/css"/>
<link  rel="stylesheet" href="./css/tabulator_lcbc.css" type="text/css">
<script type="text/javascript" src="./js/xlsx.full.min.js"></script>
<script type="text/javascript" src="./js/tabulator.min.js"></script>
<script type="text/javascript" src="./js/lcalerts.js"></script>
<script type="text/javascript" src="./js/lchelper.js"></script>
<script type="text/javascript" src="./js/jquery.min.js"></script>
<script type="text/javascript" src="./js//popper.min.js"></script>
<script type="text/javascript" src="./js//bootstrap.min.js"></script>

<title>
  NOAS - Query results
</title>
</head>
<body>
    
  <nav class="navbar navbar-expand navbar-dark">
    <a class="navbar-brand font-weight-bold" href="./select.html">
      NOAS
    </a>
  </nav>

  <div class="container">
    <div id="alerts"></div>
  </div>
  <div class="d-flex">
    <div class="h4 mt-1">
      Database Results
      <a href="#" data-toggle="popover" data-trigger="focus" title="Help"
        data-content="Select the data you are interested in and press 'Submit' (bottom).">
        <i class="bluehover fas fa-question-circle" aria-hidden="true"></i>
      </a>
    </div>
    <div id="btnSave" class="button button-minwidth ml-auto">Save selection</div>
    <div id="btnDlCsv" class="button button-minwidth">Download CSV</div>
    <div id="btnDlXlsx" class="button button-minwidth">Download Excel</div>
    <div type="button" class="button button-minwidth" data-toggle="modal" data-target="#modalImportR">Import to R</div>
    <div id="btnBack" class="button button-minwidth">Back</div>
  </div>
  <div id="noasTable" class="mt-2"></div>
  <div class="mb-5"></div>

  <div class="modal" id="modalImportR">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Copy&paste into R</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body"><code id="codeImportR" style="white-space: pre-wrap;">
        </code></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
        </div>
  
      </div>
    </div>
  </div>

  <script>
    var g_table = null;

    async function getTableData(selection) {
      async function _getData(url) {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
          'Content-Type': 'application/json'
          },
          body: JSON.stringify(selection),
        });
        if (!response.ok) {
          throw new Error(response.statusText);
        }
        return response.json();
      }
      let jsn = await _getData("./query_json.php");
      if (!jsn.status_ok) {
        throw Error(jsn.status_msg);
      }
      return jsn.data;
    }


    function getColDef(coldefs) {
      let colCalcN = function(values, data, calcParams) {
        return "n=" + values.length.toString();
      }
      let colCalcAvg = function(values, data, calcParams){
        values = values.filter(e => e !== null);
        const mean = values.reduce( (a,b) => a + parseFloat(b), 0) / values.length;
        return "avg=" + (mean).toPrecision(4);
      }
      let colCalcAvgSd = function(values, data, calcParams){
        values = values.filter(e => e !== null);
        const n = values.length
        const mean = values.reduce( (a,b) => a + parseFloat(b), 0) / n;
        const sd = Math.sqrt(values.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / n)
        return `avg=${mean.toPrecision(3)};SD=${sd.toPrecision(3)}`;
      }
      return coldefs.map( e => {
        let r = {
          title: e.id,
          field: e.id,
          minWidth: 90
        }
        if (e.idx == 0) {
          r.topCalc = colCalcN;
          r.bottomCalc = colCalcN;
          r.minWidth = 120;
        } else if (e.type == "float" || e.type == "int") {
          r.topCalc = colCalcAvgSd;
          r.bottomCalc = colCalcAvgSd;
          r.sorter = "number";
        }
        return r;
      });
    };

    function getSelection() {
      try {
        const storage = window.sessionStorage.getItem('selection');
        if (!storage) {
          throw new Error("Session expired - Please select columns <a href='./select.html'>here</b></a>.")
        }
        const sel = JSON.parse(storage);
        return sel;
       } catch (e) {
        showAlertBox(AlertType.ERROR, ["Unable to get selected data.", e.toString()]);
        console.log("err: " + e.toString());
      }
    }

    async function loadTable() {
      try {
        const sel = getSelection();
        // make db query
        document.getElementById("noasTable").innerHTML = '<br><br><h4>loading data...</h4>';
        g_table_data = await getTableData(sel);
        //console.log(g_table_data);
        //console.log( getColDef(g_table_data.column_def));
        document.getElementById("noasTable").innerHTML = '<br><br><h4>preparing table...</h4>';


        // show data in table
        g_table = new Tabulator("#noasTable", {
          layout: "fitColumns", 
          pagination: "local",
          paginationSize: 40,
          columns: getColDef(g_table_data.column_def),
          downloadConfig:{
            columnCalcs: false,
          },
          data: g_table_data.rows,
          /* replace null elements with empty string */
          downloadDataFormatter:function(data){
            data = JSON.parse(JSON.stringify(data).replace(/null/g, '""'))
            return data
          }
        });
        const host = window.location.hostname;
        const port = window.location.port != "" ? window.location.port : 80
        document.getElementById("codeImportR").innerHTML = 
          `d_noas <- (function(){\n` +
          `  selection <- '{ "columns": [\n` +
        sel.columns.map(e => `    { "table_id": "${e.table_id}", "column_id": "${e.column_id}" }`).join(",\n") + "\n" +
          `   ], "set_op": "intersect" }'\n` +
          `  header <- paste0(c(NULL\n` +
          `    ,'POST /query_tsv.php HTTP/1.0'\n` +
          `    ,'Content-Type: application/json'\n` +
          `    ,sprintf('Content-Length: %d', nchar(selection))\n` +
          `    ,'Connection: close'\n` +
          `  ), collapse='\\r\\n')\n` + 
          `  con <- socketConnection(host='${host}', port=${port}, blocking=T, server=F, open='r+')\n` +
          `  on.exit(close(con))\n` +
          `  write(sprintf('%s\\r\\n\\r\\n%s', header, selection), con);\n` +
          `  pl_str <- paste0(readLines(con), collapse='\\n'); # receive data\n` +
          `  table_str <- substr(pl_str, regexpr('\\n\\n', pl_str)+2, nchar(pl_str)); # skip http header\n` +
          `  return(read.table(text=table_str, header=T, sep='\\t', na.strings='None', stringsAsFactors=F))\n` +
          `})()\n`;

          
        //document.getElementById("noasTable").innerHTML = `<code style="white-space: pre-line;">${tableJsn}</code>`;
      } catch (e) {
        showAlertBox(AlertType.ERROR, ["Unable to get table data.", e.toString()]);
        console.log("err: " + e.toString());
      }
    }

    loadTable();

    document.getElementById("btnSave").addEventListener('click', () => lcSaveSelection(getSelection()));
    document.getElementById("btnDlCsv").addEventListener('click', function() {
      const sel = getSelection();
      const dlfilename = `noas_query_${lcGetDateFnStr(Date.parse(g_table_data.date))}_${lcGetSelHash(sel)}.csv`;
      g_table.download("csv", dlfilename, {delimiter:";"});
    });
    document.getElementById("btnDlXlsx").addEventListener('click', function() {
      const sel = getSelection();
      const md5 = lcGetSelHash(sel);
      const dlfilename = `noas_query_${lcGetDateFnStr(Date.parse(g_table_data.date))}_${md5}.xlsx`;
      g_table.download("xlsx", dlfilename, {sheetName:"NOAS download " + md5 });
    });
    document.getElementById("btnBack").addEventListener('click', () => {history.back()});
    
  </script>
</body>
