<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<link rel="shortcut icon" href="/static/img/favicon.ico">
<link rel="stylesheet" href="/static/css/layout.css" type="text/css"/>
<link rel="stylesheet" href="/static/css/bootstrap.min.css" type="text/css"/>
<link rel="stylesheet" href="/static/css/bootstrap.css" type="text/css"/>
<script type="text/javascript" src="/static/js/solid.min.js" ></script>
<script type="text/javascript" src="/static/js/fontawesome.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.min.js"></script>
<script type="text/javascript" src="/static/js//popper.min.js"></script>
<script type="text/javascript" src="/static/js/bootstrap.min.js"></script>

<link rel="stylesheet" href="/static/css/optbox.css" type="text/css"/>

<title>
NOAS - Query selector
</title>
</head>
<body>
  
  <nav class="navbar navbar-expand navbar-dark">
    <a class="navbar-brand font-weight-bold" href="/">
      NOAS
    </a>
    <!-- <ul class="navbar-nav">
      <li class="nav-item">
        <a class="navbar-brand" href="/">Query</a>
      </li>
    </ul> -->
  </nav>

  <h4 class="mt-1">
    Database Query
    <a href="#" data-toggle="popover" data-trigger="focus" title="Help"
      data-content="Select the data you are interested in and press 'Submit'.
      If you want data sets in addition to the core data,
      make sure to use the 'include this data' checkbox.">
      <i class="bluehover fas fa-question-circle" aria-hidden="true"></i>
    </a>
  </h4>
  <div class="container">
    <div id="alerts"></div>
  </div>
  <div id="noasTables">
    loading...
  </div>
  <div class="mt-4">
    <div id="submit" class="button">Submit</div><div id="btnSave" class="button">Save selection</div>
  </div>
  <div class="mb-5"></div>

<!-- enable popovers -->
<script>
  $(document).ready(function(){
    $('[data-toggle="popover"]').popover();
  });
</script>
<script>
// bootstrap alerts
const AlertType = {
  ERROR: "error",
}
function showAlertBox(alertType, msg) {
  let epar = document.querySelector('#alerts');
  let en = document.createElement('div');
  en.classList.add('alert');
  switch (alertType) {
    case AlertType.ERROR:
      console.log("sd");
      en.classList.add('alert-danger');
      en.classList.add('mt-1');
      break;
  }
  en.innerHTML = msg;
  epar.appendChild(en);
}
</script>
<script>
  var g_cfg = {
    get_meta_url: '/dbmeta'
  };

  async function getMetaData(mdAlert, dateMin) {
    async function _getData(url) {
      const response = await fetch(url, {
        method: 'GET'
      });
      if (!response.ok) {
        throw new Error(response.statusText);
      }
      return response.json();
    }
    try {
      let data = await _getData(g_cfg.get_meta_url);
      return data;
    } catch (e) {
      showAlertBox(AlertType.ERROR, "Unable to load data.<br>" + e.toString());
      console.log("err: " + e.toString());
    };
    return {};
  }

  async function start() {
    const meta = await getMetaData();
    let eNoasTables = document.querySelector("#noasTables");
    eNoasTables.innerHTML = '';
    meta.tables.forEach((e,i) => {
      let eOptbox = document.createElement('div');
      eNoasTables.appendChild(eOptbox);
      eOptbox.classList.add("optbox");
      eOptbox.id = `noasTable_${e.id}`;
      // box header
      let eOpthead = document.createElement('div');
      eOptbox.appendChild(eOpthead);
      eOpthead.classList.add("opthead");
      let eOptheadTable = document.createElement('table');
      eOpthead.appendChild(eOptheadTable);
      let eOptheadTableTr = document.createElement('tr');
      eOptheadTable.appendChild(eOptheadTableTr);
      let eOptheadTableTd = document.createElement('td');
      eOptheadTableTr.appendChild(eOptheadTableTd);
      eOptheadTableTd.classList.add("optopener");
      let eArrow = document.createElement('i');
      eOptheadTableTd.append(eArrow);
      eArrow.classList.add("ddarrow");
      const strCategory = e.category ? `[${e.category}] ` : '';
      eOptheadTableTd.insertAdjacentHTML('beforeend',
        `${strCategory}${e.title} (${e.id}; n=${e.n})`
      );
      // open / close
      eOptheadTableTd.addEventListener('click', () => {
        eOptbody.classList.toggle('openoptbody');
        eArrow.classList.toggle('openddarrow');
      });
      // box body (columns)
      let eOptbody = document.createElement('div');
      eOptbox.appendChild(eOptbody);
      eOptbody.classList.add("optbody");
      let eOptcontent = document.createElement('div');
      eOptbody.appendChild(eOptcontent);
      eOptcontent.classList.add("optcontent");
      eOptcontent.classList.add("container");
      eOptcontent.classList.add("mx-1");
      // columns
      let eRow = document.createElement("div");
      eOptcontent.appendChild(eRow);
      eRow.classList.add("row");
      e.cols.forEach((ec,i) => {
        let eCol = document.createElement("div");
        eRow.appendChild(eCol);
        eCol.classList.add("col-sm-3");
        eCol.classList.add("mb-2");
        eCol.classList.add("form-group");
        eCol.classList.add("form-check");
        let eLabel = document.createElement("label");
        eCol.appendChild(eLabel);
        eLabel.classList.add("form-check-label");
        eLabel.classList.add("font-weight-normal");
        let eCheck = document.createElement("input");
        eLabel.appendChild(eCheck);
        eCheck.id = `colcheck_${e.id}_${ec.id}`;
        eCheck.type = 'checkbox';
        eCheck.classList.add("mr-3");
        eCheck.noasTableId = e.id;
        eCheck.noasColId = ec.id;
        eCheck.value = "1";
        eLabel.insertAdjacentHTML('beforeend', ec.title)
      });
      // select all button
      if (i > 0) {
        let eSelAll = document.createElement('a');
        eOptcontent.appendChild(eSelAll);
        eSelAll.classList.add("opt-selectall");
        eSelAll.classList.add("mt-2");
        const strSelAll = "Select all";
        const strUnselAll = "Unselect all";
        eSelAll.insertAdjacentHTML('beforeend', "Select all");
        eSelAll.addEventListener('click', (e) => {
          let doSel = e.srcElement.innerHTML == strSelAll;
          e.srcElement.innerHTML = doSel ? strUnselAll : strSelAll;
          eOptcontent.querySelectorAll("input").forEach(e => {
            e.checked = doSel;
          })
        });
      }
    });
    // query options
    let eOptbox = document.createElement('div');
    eNoasTables.appendChild(eOptbox);
    eOptbox.classList.add("optbox");
    eOptbox.id = `queryOpts`;
    // query options box header
    let eOpthead = document.createElement('div');
    eOptbox.appendChild(eOpthead);
    eOpthead.classList.add("opthead");
    let eOptheadTable = document.createElement('table');
    eOpthead.appendChild(eOptheadTable);
    let eOptheadTableTr = document.createElement('tr');
    eOptheadTable.appendChild(eOptheadTableTr);
    let eOptheadTableTd = document.createElement('td');
    eOptheadTableTr.appendChild(eOptheadTableTd);
    eOptheadTableTd.classList.add("optopener");
    let eArrow = document.createElement('i');
    eOptheadTableTd.append(eArrow);
    eArrow.classList.add("ddarrow");
    eOptheadTableTd.insertAdjacentHTML('beforeend', "Query Options");
    // query options open / close
    eOptheadTableTd.addEventListener('click', () => {
      eOptbody.classList.toggle('openoptbody');
      eArrow.classList.toggle('openddarrow');
    });
    // query options box body (columns)
    let eOptbody = document.createElement('div');
    eOptbox.appendChild(eOptbody);
    eOptbody.classList.add("optbody");
    let eOptcontent = document.createElement('div');
    eOptbody.appendChild(eOptcontent);
    eOptcontent.classList.add("optcontent");
    eOptcontent.classList.add("container");
    eOptcontent.classList.add("mx-1");
    [ 
      { id: "all",       text: "all visits (all n and many missing values)"},
      { id: "union",     text: "union of datasets"},
      { id: "intersect", text: "intersection of datasets (few n and few missing values)"},
    ].forEach((er,i) => {
      let eLabel = document.createElement("label");
      eOptcontent.appendChild(eLabel);
      let eRadio = document.createElement("input");
      eLabel.appendChild(eRadio);
      eRadio.id = er.id;
      eRadio.type = 'radio';
      eRadio.name = "optionsJoin";
      eRadio.classList.add("mr-3");
      eLabel.insertAdjacentHTML('beforeend', er.text)
      eOptcontent.appendChild(document.createElement('br'));
      eRadio.checked = i == 2; // preselect intersect 
    }); // end query options

    // preselect some cols
    let ecbcsubj = document.querySelector("#colcheck_core_subject_id");
    ecbcsubj.checked = true;
    ecbcsubj.disabled = true;
    document.querySelector("#colcheck_core_project_id").checked = true;
    document.querySelector("#colcheck_core_wave_code").checked = true;
    document.querySelector("#colcheck_core_subject_sex").checked  = true;
    // open default boxes
    document.querySelector("#noasTable_core td").click();
    document.querySelector("#queryOpts td").click();
  }
  
  // save selection
  function saveSelecion() {
    let sel = {
      columns: []  
    };
    let cbs = document.querySelectorAll("[id^='colcheck_']");
    cbs.forEach(e => {
      if (!e.checked) {
        return;
      }
      sel.columns.push([e.noasTableId, e.noasColId]);
    });
    const d = new Date();
    const dyr = new Intl.DateTimeFormat('en', { year:   'numeric' }).format(d);
    const dmo = new Intl.DateTimeFormat('en', { month:  '2-digit' }).format(d);  
    const ddy = new Intl.DateTimeFormat('en', { day:    '2-digit' }).format(d);  
    const dhr = new Intl.DateTimeFormat('en', { hour:   '2-digit', hour12: false}).format(d);  
    const dmi = new Intl.DateTimeFormat('en', { minute: '2-digit' }).format(d);  
    const dsc = new Intl.DateTimeFormat('en', { second: '2-digit' }).format(d);  
    fileName = `noas_selection_${dyr}-${dmo}-${ddy}_${dhr}-${dmi}-${dsc}.json`;
    let json = JSON.stringify(sel);
    let file = new File([json], fileName, {type: "octet/stream"});
    let exportUrl = URL.createObjectURL(file);
    window.location.assign(exportUrl);
    URL.revokeObjectURL(exportUrl);
  }

  document.querySelector("#btnSave").addEventListener('click', saveSelecion);
  
  start();

</script>
</body>
</html>